<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¼«ç”» - æˆ‘çš„ä¹¦æ¶</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="/">ä¹¦æ¶</a>
      <a href="/admin.html">ç®¡ç†</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div class="breadcrumb"><a href="/">ä¹¦æ¶</a><span>â€º</span><span>æ¼«ç”»</span></div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>

  <script>
    // ä¸»é¢˜
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
      if (s.site_desc) document.querySelector('meta[name="description"]').content = s.site_desc;
      document.title = (s.site_name ? 'æ¼«ç”» - ' + s.site_name : 'æ¼«ç”» - æˆ‘çš„ä¹¦æ¶');
    }).catch(() => {});

    // å°é¢é¢œè‰²ç”Ÿæˆï¼ˆå¤ç”¨é¦–é¡µé€»è¾‘ï¼‰
    const COVER_COLORS = ['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c','#3498db','#9b59b6','#e91e63','#00bcd4','#ff5722'];
    function coverColor(title) { let h = 0; for (let i = 0; i < (title||'').length; i++) h = ((h << 5) - h + title.charCodeAt(i)) | 0; return COVER_COLORS[Math.abs(h) % COVER_COLORS.length]; }

    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

    async function loadComics() {
      const el = document.getElementById('content');
      try {
        const res = await fetch('/api/comics');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
        const comics = data.comics || [];
        if (comics.length === 0) {
          el.className = '';
          el.innerHTML = '<div class="empty"><p>ğŸ–¼ï¸ æš‚æ— æ¼«ç”»</p><p>å»<a href="/admin.html">ç®¡ç†åå°</a>å¯¼å…¥ä¸€æœ¬ CBZ å§</p></div>';
          return;
        }
        el.className = 'book-grid-cover';
        el.innerHTML = comics.map(c => {
          const title = c.title || 'æœªå‘½å';
          const meta = `${c.page_count || 0} é¡µ`;
          if (c.cover_url) {
            return `<a class="book-card-cover" href="/comic-read.html?id=${c.id}">
              <img class="cover-img" src="${esc(c.cover_url)}" alt="${esc(title)}" loading="lazy">
              <div class="card-body">
                <h3>${esc(title)}</h3>
                <div class="meta">${esc(meta)}</div>
              </div>
            </a>`;
          }
          const color = coverColor(title);
          const firstChar = (title || '?')[0];
          return `<a class="book-card-cover" href="/comic-read.html?id=${c.id}">
            <div class="cover-placeholder" style="background:${color}">${esc(firstChar)}</div>
            <div class="card-body">
              <h3>${esc(title)}</h3>
              <div class="meta">${esc(meta)}</div>
            </div>
          </a>`;
        }).join('');
      } catch (e) {
        el.className = '';
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }
    loadComics();
  </script>
</body>
</html>

