<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¼«ç”»é˜…è¯»</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a574">
</head>
<body>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="/comics.html" id="back-link">è¿”å›æ¼«ç”»</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="container">
    <div class="breadcrumb" id="breadcrumb"><a href="/comics.html">æ¼«ç”»</a><span>â€º</span><span>åŠ è½½ä¸­...</span></div>

    <div id="msg" style="margin-top:12px"></div>
    <div style="margin-top:12px;text-align:center">
      <img id="page-img" alt="" style="max-width:100%;height:auto;border-radius:var(--radius);border:1px solid var(--border);background:var(--card-bg);display:none">
      <div id="loading" class="loading">åŠ è½½ä¸­...</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:12px">
      <button class="btn btn-sm" id="prev-btn">ä¸Šä¸€é¡µ</button>
      <div id="page-indicator" style="font-size:13px;color:var(--text-light)"></div>
      <button class="btn btn-sm" id="next-btn">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>

  <script>
    // ä¸»é¢˜
    const THEMES = ['light','dark','green','sepia','blue'];
    const THEME_ICONS = {'light':'ğŸŒ™','dark':'â˜€ï¸','green':'ğŸƒ','sepia':'ğŸ“œ','blue':'ğŸ’§'};
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const idx = THEMES.indexOf(current);
      const next = THEMES[(idx + 1) % THEMES.length];
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      const t = document.documentElement.getAttribute('data-theme');
      btn.textContent = THEME_ICONS[t] || 'ğŸŒ™';
    }

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function showMsg(text, type) {
      const el = document.getElementById('msg');
      el.className = type ? `msg msg-${type}` : '';
      el.textContent = text || '';
    }

    const qs = new URLSearchParams(location.search);
    const comicId = qs.get('id');
    if (!comicId || !/^\d+$/.test(comicId)) {
      document.getElementById('loading').textContent = 'æ— æ•ˆçš„æ¼«ç”»ID';
    } else {
      init();
    }

    let comic = null;
    let currentPage = 1;

    function getSavedPage(id) {
      try {
        const v = JSON.parse(localStorage.getItem('comic_reading_' + id));
        return v && v.page ? Number(v.page) : null;
      } catch { return null; }
    }
    function saveProgress(id, page, title) {
      try {
        localStorage.setItem('comic_reading_' + id, JSON.stringify({ page, title, time: Date.now() }));
      } catch {}
    }

    async function init() {
      try {
        const res = await fetch(`/api/comics/${comicId}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
        comic = data.comic;
        document.title = (comic.title || 'æ¼«ç”»é˜…è¯»') + ' - æˆ‘çš„ä¹¦æ¶';
        document.getElementById('breadcrumb').innerHTML = `<a href="/comics.html">æ¼«ç”»</a><span>â€º</span><span>${esc(comic.title || 'æœªå‘½å')}</span>`;

        const pageParam = qs.get('page');
        const saved = getSavedPage(comicId);
        currentPage = pageParam && /^\d+$/.test(pageParam) ? Number(pageParam) : (saved || 1);
        if (currentPage < 1) currentPage = 1;
        if (comic.page_count && currentPage > comic.page_count) currentPage = comic.page_count;

        bindControls();
        await loadPage(currentPage, true);
      } catch (e) {
        showMsg(e.message, 'error');
        document.getElementById('loading').textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    function bindControls() {
      document.getElementById('prev-btn').addEventListener('click', () => goPage(currentPage - 1));
      document.getElementById('next-btn').addEventListener('click', () => goPage(currentPage + 1));
      window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') goPage(currentPage - 1);
        if (e.key === 'ArrowRight') goPage(currentPage + 1);
      });
    }

    async function goPage(page) {
      if (!comic) return;
      if (page < 1) return;
      if (comic.page_count && page > comic.page_count) return;
      await loadPage(page, false);
    }

    async function loadPage(page, replaceState) {
      showMsg('', '');
      const img = document.getElementById('page-img');
      const loading = document.getElementById('loading');
      img.style.display = 'none';
      loading.style.display = '';
      loading.textContent = 'åŠ è½½ä¸­...';

      const pageCount = comic?.page_count || 0;
      document.getElementById('page-indicator').textContent = pageCount ? `ç¬¬ ${page} / ${pageCount} é¡µ` : `ç¬¬ ${page} é¡µ`;
      document.getElementById('prev-btn').disabled = page <= 1;
      document.getElementById('next-btn').disabled = pageCount ? page >= pageCount : false;

      const url = new URL(location.href);
      url.searchParams.set('id', String(comicId));
      url.searchParams.set('page', String(page));
      if (replaceState) history.replaceState(null, '', url.toString());
      else history.pushState(null, '', url.toString());

      const src = `/api/comics/${comicId}/pages/${page}`;
      img.alt = comic?.title ? comic.title + ' - ' + page : 'page ' + page;
      img.src = src;
      currentPage = page;

      const ok = await new Promise(resolve => {
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
      });

      loading.style.display = 'none';
      if (!ok) {
        showMsg('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼Œå¯èƒ½è¯¥é¡µä¸å­˜åœ¨æˆ–ç½‘ç»œå¼‚å¸¸ã€‚', 'error');
        return;
      }
      img.style.display = '';
      saveProgress(comicId, page, comic?.title || '');
    }
  </script>
</body>
</html>

