<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜…è¯»</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="progress-bar" id="progress-bar"></div>
  <div class="navbar">
    <h1><a href="/">ğŸ“š æˆ‘çš„ä¹¦æ¶</a></h1>
    <nav>
      <a href="#" id="back-link">è¿”å›ç›®å½•</a>
      <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    </nav>
  </div>
  <div class="reader">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="reader-toolbar">
      <span style="font-size:13px;color:var(--text-light)">å­—å·</span>
      <button class="font-btn" onclick="changeFontSize(-1)">A-</button>
      <span id="font-label" style="font-size:13px;min-width:40px;text-align:center">17px</span>
      <button class="font-btn" onclick="changeFontSize(1)">A+</button>
    </div>
    <div id="content" class="loading">åŠ è½½ä¸­...</div>
  </div>
  <button class="back-to-top" id="back-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

  <script>
    // ä¸»é¢˜åˆå§‹åŒ–
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeBtn();

    // å­—å·åˆå§‹åŒ–
    let fontSize = parseInt(localStorage.getItem('font-size')) || 17;
    applyFontSize();

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeBtn();
    }
    function updateThemeBtn() {
      const btn = document.querySelector('.theme-toggle');
      btn.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    function changeFontSize(delta) {
      fontSize = Math.max(14, Math.min(24, fontSize + delta));
      localStorage.setItem('font-size', fontSize);
      applyFontSize();
    }
    function applyFontSize() {
      document.documentElement.style.setProperty('--font-size', fontSize + 'px');
      const label = document.getElementById('font-label');
      if (label) label.textContent = fontSize + 'px';
    }

    // è¿›åº¦æ¡
    window.addEventListener('scroll', () => {
      const h = document.documentElement.scrollHeight - window.innerHeight;
      const pct = h > 0 ? (window.scrollY / h * 100) : 0;
      document.getElementById('progress-bar').style.width = pct + '%';
      // è¿”å›é¡¶éƒ¨æŒ‰é’®
      document.getElementById('back-top').classList.toggle('visible', window.scrollY > 400);
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'ArrowLeft' && prevUrl) location.href = prevUrl;
      if (e.key === 'ArrowRight' && nextUrl) location.href = nextUrl;
      if (e.key === 'Escape' && backUrl) location.href = backUrl;
    });

    let prevUrl = null, nextUrl = null, backUrl = null;

    // åŠ è½½ç«™ç‚¹è®¾ç½®
    fetch('/api/settings').then(r => r.json()).then(d => {
      const s = d.settings || {};
      if (s.site_name) document.querySelector('.navbar h1 a').textContent = 'ğŸ“š ' + s.site_name;
    }).catch(() => {});

    const chapterId = new URLSearchParams(location.search).get('id');
    if (!chapterId || !/^\d+$/.test(chapterId)) {
      document.getElementById('content').innerHTML = '<div class="msg msg-error">æ— æ•ˆçš„ç« èŠ‚ID</div>';
    } else {
      loadChapter();
    }

    async function loadChapter() {
      const el = document.getElementById('content');
      try {
        const res = await fetch(`/api/chapters/${chapterId}`);
        if (!res.ok) throw new Error(res.status === 404 ? 'ç« èŠ‚ä¸å­˜åœ¨' : 'åŠ è½½å¤±è´¥');
        const data = await res.json();
        const c = data.chapter;

        // SEO
        document.title = esc(c.title) + ' - ' + esc(c.book_title);
        const metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = `${c.book_title} - ${c.title}`;

        // é¢åŒ…å±‘
        backUrl = `/book.html?id=${c.book_id}`;
        document.getElementById('back-link').href = backUrl;
        document.getElementById('breadcrumb').innerHTML =
          `<a href="/">ä¹¦æ¶</a><span>â€º</span><a href="/book.html?id=${c.book_id}">${esc(c.book_title)}</a><span>â€º</span>${esc(c.title)}`;

        // æ­£æ–‡ï¼ˆtextContenté˜²XSSï¼‰
        const contentDiv = document.createElement('div');
        contentDiv.className = 'reader-content';
        contentDiv.textContent = data.content;

        // å¯¼èˆª
        prevUrl = data.prevChapter ? `/read.html?id=${data.prevChapter.id}` : null;
        nextUrl = data.nextChapter ? `/read.html?id=${data.nextChapter.id}` : null;

        const nav = document.createElement('div');
        nav.className = 'reader-nav';
        nav.innerHTML = `
          ${prevUrl ? `<a href="${prevUrl}">â† ${esc(data.prevChapter.title)}</a>` : '<span class="disabled">å·²æ˜¯ç¬¬ä¸€ç« </span>'}
          <a href="/book.html?id=${c.book_id}">ç›®å½•</a>
          <a href="#" onclick="exportThis();return false" style="font-size:13px">å¯¼å‡ºTXT</a>
          ${nextUrl ? `<a href="${nextUrl}">${esc(data.nextChapter.title)} â†’</a>` : '<span class="disabled">å·²æ˜¯æœ€æ–°ç« </span>'}
        `;

        // å­˜å‚¨å½“å‰ç« èŠ‚æ•°æ®ç”¨äºå¯¼å‡º
        window._chapterData = { content: data.content, title: c.title };

        el.innerHTML = `<h2>${esc(c.title)}</h2>`;
        el.appendChild(contentDiv);
        el.appendChild(nav);

        // ä¿å­˜é˜…è¯»è¿›åº¦
        localStorage.setItem(`reading_${c.book_id}`, JSON.stringify({
          chapterId: c.id, title: c.title, time: Date.now()
        }));
      } catch (e) {
        el.innerHTML = `<div class="msg msg-error">${esc(e.message)}</div>`;
      }
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function exportThis() {
      if (!window._chapterData) return;
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + window._chapterData.content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (window._chapterData.title + '.txt').replace(/[<>:"/\\|?*]/g, '_');
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
